{% extends "base.html" %}

{% block title %}Dashboard - Audio Analysis{% endblock %}

{% block content %}
<div class="main-container">
    <div class="page-header">
        <h1>Audio Analysis Dashboard</h1>
        <p class="page-subtitle">Upload and analyze lung sound recordings for respiratory disease detection</p>
    </div>

    <!-- Upload Section with Patient Form -->
    <div class="upload-card">
        <h3 style="margin-bottom: 2rem; color: var(--text-dark);">
            <i class="fas fa-user-injured"></i> New Patient Analysis
        </h3>
        
        <form id="uploadForm" enctype="multipart/form-data">
            <!-- Patient Information -->
            <div style="background: #F8F9FA; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1.5rem; color: var(--primary-blue);">
                    <i class="fas fa-user"></i> Patient Information
                </h4>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            First Name *
                        </label>
                        <input type="text" name="first_name" id="firstName" required
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;"
                               placeholder="First name">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Middle Name
                        </label>
                        <input type="text" name="middle_name" id="middleName"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;"
                               placeholder="Middle name (optional)">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Last Name *
                        </label>
                        <input type="text" name="last_name" id="lastName" required
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;"
                               placeholder="Last name">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Patient ID *
                        </label>
                        <input type="text" name="patient_id" id="patientId" required maxlength="4" pattern="[0-9]{4}"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;"
                               placeholder="4-digit ID (e.g., 1234)">
                        <small style="color: var(--text-light); font-size: 0.85rem;">Must be exactly 4 digits</small>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Phone Number *
                        </label>
                        <input type="tel" name="phone_number" id="phoneNumber" required maxlength="10" pattern="[0-9]{10}"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;"
                               placeholder="10-digit number (e.g., 1234567890)">
                        <small style="color: var(--text-light); font-size: 0.85rem;">Must be exactly 10 digits</small>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Date of Birth
                        </label>
                        <input type="date" name="date_of_birth"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;">
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Gender
                        </label>
                        <select name="gender"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Email Address
                        </label>
                        <input type="email" name="email_address"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;"
                               placeholder="patient@example.com">
                        <small style="color: var(--text-light); font-size: 0.85rem;">Optional</small>
                    </div>
                </div>
            </div>

            <!-- Clinical Context -->
            <div style="background: #F8F9FA; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1.5rem; color: var(--primary-blue);">
                    <i class="fas fa-stethoscope"></i> Clinical Context
                </h4>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Recording Date/Time
                        </label>
                        <input type="datetime-local" name="recording_datetime" id="recordingDateTime"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;">
                        <small style="color: var(--text-light); font-size: 0.85rem;">Auto-populated, editable</small>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Visit Type
                        </label>
                        <select name="visit_type"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;">
                            <option value="">Select Visit Type</option>
                            <option value="Initial Assessment">Initial Assessment</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Screening">Screening</option>
                            <option value="Emergency">Emergency</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Recording Details (Collapsible) -->
            <div style="background: #F8F9FA; padding: 1rem 2rem; border-radius: 12px; margin-bottom: 2rem;">
                <div onclick="toggleRecordingDetails()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;">
                    <h4 style="margin: 0; color: var(--primary-blue);">
                        <i class="fas fa-microphone"></i> Recording Details (Optional)
                    </h4>
                    <i class="fas fa-chevron-down" id="recordingDetailsIcon" style="color: var(--primary-blue); transition: transform 0.3s;"></i>
                </div>

                <div id="recordingDetailsContent" style="display: none; margin-top: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                Recording Location
                            </label>
                            <select name="recording_location"
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px;">
                                <option value="chest">Chest (Anterior)</option>
                                <option value="back">Back (Posterior)</option>
                                <option value="left">Left Side</option>
                                <option value="right">Right Side</option>
                                <option value="apex">Apex</option>
                                <option value="base">Base</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                Clinical Notes
                            </label>
                            <textarea name="clinical_notes" rows="4"
                                      style="width: 100%; padding: 0.75rem; border: 1px solid #E1E8ED; border-radius: 8px; resize: vertical; font-family: inherit;"
                                      placeholder="Provider observations, symptoms, auscultation findings, etc."></textarea>
                            <small style="color: var(--text-light); font-size: 0.85rem;">Optional observations and notes</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audio File Upload -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <h3>Drag and drop your audio file here</h3>
                <p>or click to browse and select file</p>
                <p class="format-info">Supported formats: WAV, MP3, FLAC (max 50MB)</p>
                <input type="file" id="audioFile" name="audio_file" accept="audio/*" required>
            </div>

            <div id="fileInfo" style="display: none; background: #E3F2FD; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <strong>Selected file:</strong> <span id="fileName"></span>
                <button type="button" id="removeFile" style="float: right; background: none; border: none; color: #666; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="analysisProgress" style="display: none; text-align: center; margin: 2rem 0;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 1rem; color: var(--text-dark);"><strong>Analyzing lung sounds...</strong></p>
                <p style="color: var(--text-light);">This may take a few moments</p>
            </div>

            <div style="text-align: center;">
                <button type="submit" class="upload-btn" id="submitBtn">
                    <i class="fas fa-microscope"></i> Analyze Recording
                </button>
            </div>
        </form>
    </div>

   <!-- Recent Analyses -->
<div class="recent-section">
    <div class="section-header">
        <h2>Recent Analyses</h2>
        <a href="{{ url_for('patients_list') }}" class="view-all-link">View All Patients</a>
    </div>

    <ul class="upload-list">
        {% if recent_analyses %}
            {% for analysis in recent_analyses %}
            <li class="upload-item">
                <div class="upload-item-left">
                    <div class="file-icon">
                        <i class="fas fa-file-audio"></i>
                    </div>
                    <div class="file-info">
                        <h4>{{ analysis.audio_file.patient.patient_name }} - {{ analysis.audio_file.filename }}</h4>
                        <p class="file-meta">
                            Uploaded {{ analysis.analysis_date.strftime('%b %d, %Y at %I:%M %p') }} ‚Ä¢ 
                            Patient ID: {{ analysis.audio_file.patient.patient_id }}
                        </p>
                    </div>
                </div>
                <div class="upload-item-right">
                    <!-- FIXED: Changed from analysis.classification to analysis.disease_diagnosis with color coding -->
                    <span class="status-badge" 
                          style="background: {% if analysis.disease_diagnosis == 'Normal' %}linear-gradient(135deg, #10B981 0%, #059669 100%){% elif analysis.disease_diagnosis == 'Asthma' %}linear-gradient(135deg, #F59E0B 0%, #D97706 100%){% elif analysis.disease_diagnosis == 'COPD' %}linear-gradient(135deg, #EF4444 0%, #DC2626 100%){% elif analysis.disease_diagnosis == 'Pneumonia' %}linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%){% elif analysis.disease_diagnosis == 'Bronchitis' %}linear-gradient(135deg, #06B6D4 0%, #0891B2 100%){% else %}linear-gradient(135deg, #F97316 0%, #EA580C 100%){% endif %}; color: white;">
                        {{ analysis.disease_diagnosis }}
                    </span>
                    <button onclick="location.href='{{ url_for('view_results', analysis_id=analysis.id) }}'" 
                            style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary-blue); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
            </li>
            {% endfor %}
        {% else %}
            <li style="text-align: center; padding: 3rem; color: var(--text-light);">
                <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>No analyses yet. Upload your first recording above!</p>
            </li>
        {% endif %}
    </ul>
</div>
</div>
{% endblock %}  

{% block extra_js %}
<script>
// Toggle Recording Details Section
function toggleRecordingDetails() {
    const content = document.getElementById('recordingDetailsContent');
    const icon = document.getElementById('recordingDetailsIcon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Form Validation
document.getElementById('patientId').addEventListener('input', function(e) {
    // Only allow digits
    this.value = this.value.replace(/[^0-9]/g, '');
    // Limit to 4 digits
    if (this.value.length > 4) {
        this.value = this.value.slice(0, 4);
    }
});

document.getElementById('phoneNumber').addEventListener('input', function(e) {
    // Only allow digits
    this.value = this.value.replace(/[^0-9]/g, '');
    // Limit to 10 digits
    if (this.value.length > 10) {
        this.value = this.value.slice(0, 10);
    }
});

// Auto-populate recording datetime with current time
const recordingDateTimeInput = document.getElementById('recordingDateTime');
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, '0');
const day = String(now.getDate()).padStart(2, '0');
const hours = String(now.getHours()).padStart(2, '0');
const minutes = String(now.getMinutes()).padStart(2, '0');
const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
recordingDateTimeInput.value = formattedDateTime;

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('audioFile');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const removeFile = document.getElementById('removeFile');
const uploadForm = document.getElementById('uploadForm');
const submitBtn = document.getElementById('submitBtn');
const analysisProgress = document.getElementById('analysisProgress');

uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#4A90E2';
    uploadZone.style.backgroundColor = '#F0F7FF';
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.style.borderColor = '#E1E8ED';
    uploadZone.style.backgroundColor = '#FAFBFC';
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#E1E8ED';
    uploadZone.style.backgroundColor = '#FAFBFC';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        showFileInfo(files[0].name);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        showFileInfo(e.target.files[0].name);
    }
});

function showFileInfo(name) {
    fileName.textContent = name;
    fileInfo.style.display = 'block';
}

removeFile.addEventListener('click', () => {
    fileInput.value = '';
    fileInfo.style.display = 'none';
});

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(uploadForm);
    
    submitBtn.disabled = true;
    analysisProgress.style.display = 'block';
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Analysis completed successfully!');
            window.location.href = '/results/' + result.analysis_id;
        } else {
            alert('Error: ' + result.error);
            submitBtn.disabled = false;
            analysisProgress.style.display = 'none';
        }
    } catch (error) {
        alert('An error occurred during analysis');
        submitBtn.disabled = false;
        analysisProgress.style.display = 'none';
    }
});
</script>
{% endblock %}
